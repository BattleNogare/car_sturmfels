<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fahrzeughandel Sturmfels</title>

  <!-- Favicon & Logo -->
  <link rel="icon" href="https://raw.githubusercontent.com/BattleNogare/car_sturmfels/main/car-sturmfels-logo.ico"/>
  <link rel="preload" as="image" href="https://raw.githubusercontent.com/BattleNogare/car_sturmfels/main/car-sturmfels-logo.png"/>

  <style>
    /* ===== LIGHT SILVER THEME ===== */
    :root{
      --bg:#e9edf2;
      --bg2:#f5f7fa;
      --panel:#ffffff;
      --panel2:#f2f5f8;
      --border:#d7dde5;
      --edge:#cfd6e0;
      --text:#1b2430;
      --muted:#465266;
      --accent:#2e3b52;
      --accent2:#5a6a85;
      --danger:#c03b3b;
      --shadow:0 10px 24px rgba(31,41,55,.10);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 80% -10%, rgba(180,190,205,.25), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      background-attachment:fixed;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(130%) blur(6px);
      background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
      border-bottom:1px solid var(--border);
    }
    .head{max-width:1200px;margin:auto;padding:12px 18px;display:flex;align-items:center;gap:16px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:36px;width:auto;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .brand h1{font-size:20px;letter-spacing:.3px;margin:0;color:var(--accent)}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{
      border:1px solid var(--edge);
      background:linear-gradient(180deg,#f8fafc,#eef3f7);
      color:var(--accent);
      padding:10px 14px;border-radius:12px;cursor:pointer;
      box-shadow:var(--shadow);
      transition:transform .05s ease, border-color .2s, background .2s, box-shadow .2s
    }
    .btn:active{transform:translateY(1px)}
    .btn.danger{background:linear-gradient(180deg,#ffeaea,#ffd6d6); color:#7a1f1f; border-color:#f2b0b0}
    .searchbar{max-width:1200px;margin:20px auto 10px;padding:0 18px;display:flex;gap:12px;align-items:center}
    .searchbar input{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--edge);
      background:linear-gradient(180deg,#ffffff,#f3f6f9);color:var(--text);outline:none
    }
    .grid{max-width:1200px;margin:10px auto 80px;padding:10px 18px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}
    @media (max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden; box-shadow:var(--shadow);
      display:flex; flex-direction:column;
      transition:transform .12s, box-shadow .12s, border-color .2s
    }
    .card img{width:100%;height:190px;object-fit:cover;background:#e3e8ee}
    .card .meta{padding:12px 12px 14px}
    .title{font-weight:700;color:var(--accent)}
    .price{color:var(--accent2);font-weight:700}
    .owner{color:var(--muted);font-size:12px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
    .modal.active{display:flex}
    .modal::before{content:"";position:absolute;inset:0;backdrop-filter:blur(10px);background:rgba(235,239,245,.65)}
    .panel{position:relative;width:min(1000px,94vw);max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
    .images{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:4px}
    .images img{width:100%;height:260px;object-fit:cover;border-radius:10px;background:#e3e8ee}
    .images img.main{grid-column:1/-1;height:340px}
    dialog{border:none;border-radius:16px;padding:0;background:var(--panel);color:var(--text);box-shadow:var(--shadow);width:min(560px,96vw);overflow:hidden;border:1px solid var(--border)}
    .dialog-head{padding:14px 16px;border-bottom:1px solid var(--border);background:var(--panel2)}
    .dialog-body{padding:16px;display:flex;flex-direction:column;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field select,.field textarea{
      padding:10px 12px;border-radius:12px;border:1px solid var(--edge);
      background:#fff;color:var(--text);outline:none
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:560px){.row{grid-template-columns:1fr}}
    footer{color:#6c7890;font-size:12px;text-align:center;padding:30px 10px 50px}
  </style>
</head>
<body>
  <header>
    <div class="head">
      <div class="brand">
        <img src="https://raw.githubusercontent.com/BattleNogare/car_sturmfels/main/car-sturmfels-logo.png" alt="Sturmfels Logo"/>
        <h1>Fahrzeughandel Sturmfels</h1>
      </div>
      <div class="actions">
        <button class="btn" id="btnNew">+ Fahrzeug</button>
      </div>
    </div>
  </header>

  <div class="searchbar">
    <input id="q" placeholder="Suche nach Fahrzeugname, Kraftstoffart, FIN, Besitzer …"/>
    <button class="btn" id="btnSearch">Suchen</button>
    <span class="help" id="filterHint"></span>
  </div>

  <section class="grid" id="grid"></section>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="panel">
      <button class="btn danger" id="closeModal">Schließen ✕</button>
      <div class="images" id="modalImages"></div>
      <div class="section"><h3 id="modalTitle">—</h3></div>
      <div class="section"><div id="specRows"></div></div>
      <div class="section" id="priceBlock"></div>
      <div class="section" id="contactBlock"></div>
      <div class="actions" id="ownerActions" style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="editBtn">Bearbeiten</button>
        <button class="btn danger" id="deleteBtn">Löschen</button>
      </div>
    </div>
  </div>

  <!-- Dialog: Fahrzeug anlegen/bearbeiten -->
  <dialog id="dlgVehicle">
    <div class="dialog-head"><strong id="vehDialogTitle">Fahrzeug anlegen</strong></div>
    <form method="dialog">
      <div class="dialog-body">
        <div class="field"><label>Besitzer (Pflicht)</label><input id="f_owner" required/></div>
        <div class="field"><label>Fahrzeugname</label><input id="f_name" required/></div>
        <div class="row">
          <div class="field"><label>V-MAX (km/h)</label><input id="f_vmax" type="number"/></div>
          <div class="field"><label>Leistung (PS)</label><input id="f_power" type="number"/></div>
        </div>
        <div class="row">
          <div class="field"><label>Kraftstoffart</label>
            <select id="f_fuel">
              <option>Diesel</option><option>Super</option><option>Super +</option><option>Elektro</option><option>Kerosin</option>
            </select>
          </div>
          <div class="field"><label>Sitzplätze</label><input id="f_seats" type="number"/></div>
        </div>
        <div class="row">
          <div class="field"><label>Kofferraumgröße (L)</label><input id="f_trunk" type="number"/></div>
          <div class="field"><label>FIN</label><input id="f_vin"/></div>
        </div>
        <div class="row">
          <div class="field"><label>Versicherung</label><select id="f_ins"><option>Yes</option><option>No</option></select></div>
          <div class="field"><label>Preis (€)</label><input id="f_price" type="number"/></div>
        </div>
        <div class="field"><label>Preisart</label><select id="f_pricetype"><option>Festpreis</option><option>VB</option></select></div>
        <div class="field"><label>Kontakt</label><input id="f_contact"/></div>
        <div class="section">
          <h3>Bild-Links (HTTPS)</h3>
          <div class="field"><label>Bild 1</label><input id="img1" type="url" placeholder="https://…"/></div>
          <div class="field"><label>Bild 2</label><input id="img2" type="url" placeholder="https://…"/></div>
          <div class="field"><label>Bild 3</label><input id="img3" type="url" placeholder="https://…"/></div>
          <div class="help">Fehlende Plätze werden automatisch mit Platzhaltern gespeichert (insgesamt immer 3 Bilder).</div>
        </div>
        <div class="help" id="vehMsg"></div>
        <div class="actions" style="gap:10px">
          <button class="btn" value="cancel">Abbrechen</button>
          <button class="btn" id="saveVehicle">Speichern</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Dialog: Löschen -->
  <dialog id="dlgDelete">
    <div class="dialog-head"><strong>Angebot löschen</strong></div>
    <form method="dialog">
      <div class="dialog-body">
        <div class="field"><label>Dein Name (Pflicht)</label><input id="delWho" required/></div>
        <div class="field"><label>Grund</label><select id="delReason"><option>Verkauf</option><option>Rückzug</option><option>Sonstiges</option></select></div>
        <div class="field" id="buyerWrap" style="display:none"><label>Käufer</label><input id="delBuyer"/></div>
        <div class="field" id="otherWrap" style="display:none"><label>Beschreibung</label><textarea id="delOther" rows="3"></textarea></div>
        <div class="help" id="delMsg"></div>
        <div class="actions" style="gap:10px">
          <button class="btn" value="cancel">Abbrechen</button>
          <button class="btn danger" id="confirmDelete">Endgültig löschen & archivieren</button>
        </div>
      </div>
    </form>
  </dialog>

  <footer>© Fahrzeughandel Sturmfels</footer>

  <script>
    // === DEINE GAS EXEC URL ===
    const API_BASE = "https://script.google.com/macros/s/AKfycbzIFdJ82TiaagmPyaJbfufMPwEhholEVF8FIiRd-Bb5Byd9vzzcfZTPWAhJAFH2ZKO6/exec";

    // === Client-Placeholders (für Alt-Datensätze ohne Bilder) ===
    const PLACEHOLDERS = [
      "https://raw.githubusercontent.com/BattleNogare/car_sturmfels/main/placeholder1.png",
      "https://raw.githubusercontent.com/BattleNogare/car_sturmfels/main/placeholder2.png",
      "https://raw.githubusercontent.com/BattleNogare/car_sturmfels/main/placeholder3.png"
    ];

    // === JSONP Helper ===
    function jsonp(params){
      return new Promise((resolve, reject)=>{
        const cb = "cb_" + Math.random().toString(36).slice(2);
        params.callback = cb;
        const url = new URL(API_BASE);
        Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, String(v)));
        const s = document.createElement("script");
        const timeout = setTimeout(()=>{ cleanup(); reject(new Error("Timeout")); }, 15000);
        function cleanup(){ delete window[cb]; s.remove(); clearTimeout(timeout); }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.src = url.toString();
        s.onerror = ()=>{ cleanup(); reject(new Error("JSONP error")); };
        document.body.appendChild(s);
      });
    }

    // Helpers
    const $ = s => document.querySelector(s);
    const el = (t,c)=>{ const e=document.createElement(t); if(c) e.className=c; return e; };
    const priceFmt = n => (n==null||n==="") ? "—" : Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(Number(n));
    function getImages(v){
      const arr = Array.isArray(v.images) ? v.images.filter(Boolean) : [];
      // Falls alte Fahrzeuge ohne images_json: nimm Platzhalter
      const imgs = arr.length ? arr : PLACEHOLDERS;
      // Immer 3 anzeigen (überschüssige ignorieren)
      return [imgs[0], imgs[1] || PLACEHOLDERS[1], imgs[2] || PLACEHOLDERS[2]];
    }

    // API (JSONP GET)
    const api = {
      list: () => jsonp({ action:"list" }),
      create: (data) => jsonp({ action:"create", data: JSON.stringify(data) }),
      update: (data) => jsonp({ action:"update", data: JSON.stringify(data) }),
      delete: (payload) => jsonp({ action:"delete", id: payload.id, deleter: payload.deleter, reason: payload.reason||"", buyer: payload.buyer||"", note: payload.note||"" })
    };

    // State
    let currentList = [];
    let selected = null;

    // RENDER
    function renderGrid(list){
      // Der Server liefert bereits in Erstellreihenfolge (älteste zuerst)
      const q = $("#q").value.trim().toLowerCase();
      const filtered = list.filter(v=>{
        const hay=[v.name,v.fuel,v.vin,v.owner].join(" ").toLowerCase();
        return hay.includes(q);
      });
      const grid = $("#grid");
      grid.innerHTML = "";
      if(!filtered.length){ grid.innerHTML = `<div class="help">Keine Fahrzeuge gefunden.</div>`; return; }

      filtered.forEach(v=>{
        const c = el("div","card"); c.dataset.id=v.id;
        const img = el("img"); img.src=getImages(v)[0];
        const m = el("div","meta");
        const t = el("div","title"); t.textContent=v.name||"—";
        const p = el("div","price"); p.textContent = priceFmt(v.price) + (v.pricetype?` · ${v.pricetype}`:"");
        const o = el("div","owner"); o.textContent = `Besitzer: ${v.owner||"—"}`;
        m.append(t,p,o); c.append(img,m);
        c.onclick=()=>openModal(v);
        grid.append(c);
      });
    }

    function openModal(v){
      selected=v;
      $("#modalImages").innerHTML="";
      const imgs = getImages(v);
      const main = el("img","main"); main.src=imgs[0]; $("#modalImages").append(main);
      if(imgs[1]){ const i=el("img"); i.src=imgs[1]; $("#modalImages").append(i); }
      if(imgs[2]){ const i=el("img"); i.src=imgs[2]; $("#modalImages").append(i); }
      $("#modalTitle").textContent=v.name||"—";
      const rows = [
        ["Fahrzeugname", v.name],
        ["V-MAX", v.vmax?`${v.vmax} km/h`:"—"],
        ["Leistung", v.power?`${v.power} PS`:"—"],
        ["Kraftstoffart", v.fuel||"—"],
        ["Sitzplätze", v.seats||"—"],
        ["Kofferraumgröße", v.trunk?`${v.trunk} L`:"—"],
        ["FIN", v.vin||"—"],
        ["Versicherung", v.insurance||"—"]
      ];
      $("#specRows").innerHTML = rows.map(r=>`<div><b>${r[0]}:</b> ${r[1]}</div>`).join("");
      $("#priceBlock").innerHTML = `<h3>Preis</h3><div>${priceFmt(v.price)} · ${v.pricetype||"—"}</div>`;
      $("#contactBlock").innerHTML = `<h3>Kontakt</h3><div>${v.contact||"—"}</div>`;

      $("#modal").classList.add("active");
    }
    $("#closeModal").onclick=()=>{$("#modal").classList.remove("active"); selected=null;};

    async function loadVehicles(){
      const res = await api.list();
      if(!res.ok){ alert(res.error||"Fehler"); return; }
      currentList = res.data||[];
      renderGrid(currentList);
    }

    // Suche
    $("#btnSearch").onclick=()=>renderGrid(currentList);
    $("#q").onkeydown=(e)=>{ if(e.key==="Enter") renderGrid(currentList); };

    // Create/Edit
    $("#btnNew").onclick=()=>openEdit(null);

    function openEdit(v){
      $("#vehDialogTitle").textContent = v? "Fahrzeug bearbeiten" : "Fahrzeug anlegen";
      $("#f_owner").value = v?.owner || "";
      $("#f_name").value = v?.name || "";
      $("#f_vmax").value = v?.vmax || "";
      $("#f_power").value = v?.power || "";
      $("#f_fuel").value = v?.fuel || "Diesel";
      $("#f_seats").value = v?.seats || "";
      $("#f_trunk").value = v?.trunk || "";
      $("#f_vin").value = v?.vin || "";
      $("#f_ins").value = (v?.insurance==="No"?"No":"Yes");
      $("#f_price").value = v?.price || "";
      $("#f_pricetype").value = v?.pricetype || "Festpreis";
      $("#f_contact").value = v?.contact || "";
      // Bilder: zeigen (aber Nutzer kann bewusst überschreiben/leer lassen)
      $("#img1").value = v?.images?.[0] || "";
      $("#img2").value = v?.images?.[1] || "";
      $("#img3").value = v?.images?.[2] || "";
      $("#vehMsg").textContent="";
      $("#dlgVehicle").dataset.editId = v?.id||"";
      $("#dlgVehicle").showModal();
    }

    function collectImageUrls(){
      // Server füllt auf 3 auf – hier nur https filtern
      return [$("#img1").value.trim(), $("#img2").value.trim(), $("#img3").value.trim()]
        .filter(u => /^https:\/\//i.test(u))
        .slice(0,3);
    }

    $("#saveVehicle").onclick=async (ev)=>{
      ev.preventDefault();
      if (!$("#f_owner").value.trim()){ $("#vehMsg").textContent="Besitzer ist ein Pflichtfeld."; return; }
      $("#vehMsg").textContent="Speichere…";
      const id = $("#dlgVehicle").dataset.editId || undefined;
      const data = {
        id,
        owner: $("#f_owner").value.trim(),
        name: $("#f_name").value.trim(),
        vmax: $("#f_vmax").value, power: $("#f_power").value,
        fuel: $("#f_fuel").value, seats: $("#f_seats").value,
        trunk: $("#f_trunk").value, vin: $("#f_vin").value,
        insurance: $("#f_ins").value, price: $("#f_price").value,
        pricetype: $("#f_pricetype").value, contact: $("#f_contact").value,
        images: collectImageUrls() // Server garantiert 3 mit Platzhaltern
      };
      const res = await (id ? api.update(data) : api.create(data));
      if(!res.ok){ $("#vehMsg").textContent = res.error||"Fehler"; return; }
      $("#vehMsg").textContent="Gespeichert."; $("#dlgVehicle").close(); loadVehicles();
    };

    // Delete
    function askDelete(v){
      selected=v;
      $("#delWho").value="";
      $("#delReason").value="Verkauf"; $("#delBuyer").value=""; $("#delOther").value="";
      $("#buyerWrap").style.display="block"; $("#otherWrap").style.display="none";
      $("#delMsg").textContent="";
      $("#dlgDelete").showModal();
    }
    $("#delReason").onchange=()=>{
      const r=$("#delReason").value;
      $("#buyerWrap").style.display=(r==="Verkauf")?"block":"none";
      $("#otherWrap").style.display=(r==="Sonstiges")?"block":"none";
    };
    // Buttons (im Modal sichtbar)
    $("#editBtn").onclick=()=>{ if(selected) openEdit(selected); };
    $("#deleteBtn").onclick=()=>{ if(selected) askDelete(selected); };
    $("#confirmDelete").onclick=async (ev)=>{
      ev.preventDefault();
      const who = $("#delWho").value.trim();
      if(!who){ $("#delMsg").textContent="Bitte gib deinen Namen an (Pflicht)."; return; }
      const r = $("#delReason").value;
      const res = await api.delete({
        id: selected.id,
        deleter: who,
        reason: r,
        buyer: r==="Verkauf" ? $("#delBuyer").value.trim() : "",
        note: r==="Sonstiges" ? $("#delOther").value.trim() : (r==="Rückzug" ? "Rückzug des Angebots" : "")
      });
      if(!res.ok){ $("#delMsg").textContent = res.error||"Fehler"; return; }
      $("#dlgDelete").close(); $("#modal").classList.remove("active"); loadVehicles();
    };

    // Init
    loadVehicles();
  </script>
</body>
</html>
